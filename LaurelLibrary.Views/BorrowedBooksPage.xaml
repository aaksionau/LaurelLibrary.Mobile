<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:fa="clr-namespace:UraniumUI.Icons.FontAwesome;assembly=UraniumUI.Icons.FontAwesome"
			 xmlns:models="clr-namespace:LaurelLibrary.Core.Models;assembly=LaurelLibrary.Core"
             xmlns:viewmodels="clr-namespace:LaurelLibrary.Core.ViewModels;assembly=LaurelLibrary.Core"
             x:Class="LaurelLibrary.Views.BorrowedBooksPage"
             x:DataType="viewmodels:BorrowedBooksViewModel"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">

	<Grid RowDefinitions="*" ColumnDefinitions="*" x:Name="MainGrid">
		<!-- Content State -->
		<RefreshView Grid.Row="0" Grid.Column="0"
					 IsVisible="{Binding HasBorrowedBooks}"
					 Command="{Binding RefreshCommand}"
					 BackgroundColor="Transparent">
			<ScrollView>
				<StackLayout Padding="16" Spacing="0">
					<!-- Header Section -->
					<StackLayout Padding="4,24,4,28" Spacing="8">
						<HorizontalStackLayout Spacing="12">
							<Border Padding="10"
								   StrokeShape="RoundRectangle 12"
								   StrokeThickness="0"
								   BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryLight}, Dark=#FF1F4A45}"
								   VerticalOptions="Center">
								<Label FontFamily="FASolid"
									   Text="{x:Static fa:Solid.User}"
									   FontSize="16"
									   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Accent}}"
									   VerticalTextAlignment="Center"/>
							</Border>
							<StackLayout Spacing="4" VerticalOptions="Center">
								<Label Text="{Binding ReaderName, StringFormat='Welcome back, {0}!'}"
									   FontSize="24"
									   FontAttributes="Bold"
									   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDarkText}}"/>
								<HorizontalStackLayout Spacing="8">
									<Label Text="{Binding BorrowedBooks.Count, StringFormat='{0} book(s) in your collection'}"
										   FontSize="14"
										   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
										   VerticalTextAlignment="Center"/>
								</HorizontalStackLayout>
							</StackLayout>
						</HorizontalStackLayout>
					</StackLayout>

					<!-- Library Information Card -->
					<Border IsVisible="{Binding HasLibraryInfo}"
							StrokeThickness="0"
							StrokeShape="RoundRectangle 16"
							Padding="20"
							Margin="0,0,0,20"
							BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark=#FF1F4A45}"
							Shadow="{Shadow Brush={StaticResource Primary}, Opacity=0.25, Radius=15, Offset='0,6'}">
						<StackLayout Spacing="16">
							<!-- Library Name Header -->
							<HorizontalStackLayout Spacing="12">
								<Label FontFamily="FASolid"
									   Text="{x:Static fa:Solid.Building}"
									   FontSize="36"
									   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Accent}}"
									   VerticalTextAlignment="Center"/>
								<StackLayout Spacing="2" VerticalOptions="Center">
									<Label Text="Your Library"
										   FontSize="12"
										   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray200}}"
										   Opacity="0.85"/>
									<Label Text="{Binding LibraryName}"
										   FontSize="20"
										   FontAttributes="Bold"
										   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource PrimaryDarkText}}"/>
								</StackLayout>
							</HorizontalStackLayout>

							<!-- Divider -->
							<BoxView HeightRequest="1"
									 Color="{AppThemeBinding Light={StaticResource White}, Dark=#FF404040}"
									 Opacity="0.3"
									 Margin="0,1"/>

							<!-- Statistics Grid -->
							<Grid ColumnDefinitions="*,*,*" RowDefinitions="Auto" ColumnSpacing="12">
								<!-- Books Borrowed -->
								<Border Grid.Column="0"
										StrokeShape="RoundRectangle 12"
										StrokeThickness="0"
										Padding="12,16"
										BackgroundColor="{AppThemeBinding Light=#33FFFFFF, Dark=#33000000}">
									<StackLayout Spacing="8" HorizontalOptions="Center">
										<Label FontFamily="FASolid"
											   Text="{x:Static fa:Solid.BookBookmark}"
											   FontSize="24"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Accent}}"
											   HorizontalTextAlignment="Center"/>
										<Label Text="{Binding BorrowedBooks.Count}"
											   FontSize="22"
											   FontAttributes="Bold"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Accent}}"
											   HorizontalTextAlignment="Center"/>
										<Label Text="Borrowed"
											   FontSize="11"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray300}}"
											   HorizontalTextAlignment="Center"
											   Opacity="0.9"/>
									</StackLayout>
								</Border>

								<!-- Books Due Soon -->
								<Border Grid.Column="1"
										StrokeShape="RoundRectangle 12"
										StrokeThickness="0"
										Padding="12,16"
										BackgroundColor="{AppThemeBinding Light=#33FFFFFF, Dark=#33000000}">
									<StackLayout Spacing="8" HorizontalOptions="Center">
										<Label FontFamily="FASolid"
											   Text="{x:Static fa:Solid.Clock}"
											   FontSize="24"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Warning}}"
											   HorizontalTextAlignment="Center"/>
										<Label Text="{Binding BooksDueSoon}"
											   FontSize="22"
											   FontAttributes="Bold"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Warning}}"
											   HorizontalTextAlignment="Center"/>
										<Label Text="Due Soon"
											   FontSize="11"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray300}}"
											   HorizontalTextAlignment="Center"
											   Opacity="0.9"/>
									</StackLayout>
								</Border>

								<!-- Books Overdue -->
								<Border Grid.Column="2"
										StrokeShape="RoundRectangle 12"
										StrokeThickness="0"
										Padding="12,16"
										BackgroundColor="{AppThemeBinding Light=#33FFFFFF, Dark=#33000000}">
									<StackLayout Spacing="8" HorizontalOptions="Center">
										<Label FontFamily="FASolid"
											   Text="{x:Static fa:Solid.CalendarXmark}"
											   FontSize="24"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Danger}}"
											   HorizontalTextAlignment="Center"/>
										<Label Text="{Binding BooksOverdue}"
											   FontSize="22"
											   FontAttributes="Bold"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Danger}}"
											   HorizontalTextAlignment="Center"/>
										<Label Text="Overdue"
											   FontSize="11"
											   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray300}}"
											   HorizontalTextAlignment="Center"
											   Opacity="0.9"/>
									</StackLayout>
								</Border>
							</Grid>
						</StackLayout>
					</Border>

					<!-- Books List Header -->
					<HorizontalStackLayout Spacing="8" Padding="4,0,0,12">
						<Label FontFamily="FASolid"
							   Text="{x:Static fa:Solid.ListCheck}"
							   FontSize="16"
							   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Accent}}"
							   VerticalTextAlignment="Center"/>
						<Label Text="Your Books"
							   FontSize="18"
							   FontAttributes="Bold"
							   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDarkText}}"
							   VerticalTextAlignment="Center"/>
					</HorizontalStackLayout>

					<!-- Books List -->
					<CollectionView ItemsSource="{Binding BorrowedBooks}"
									SelectionMode="None">
						<CollectionView.EmptyView>
							<StackLayout>
								<Border Padding="40"
									   StrokeShape="RoundRectangle 20"
									   StrokeThickness="0"
									   BackgroundColor="{AppThemeBinding Light=#FFF0F7F5, Dark=#FF1A3A35}"
									   Shadow="{Shadow Brush={StaticResource Primary}, Opacity=0.15, Radius=20, Offset='0,8'}">
									<Label FontFamily="FASolid"
										   Text="{x:Static fa:Solid.BookOpen}"
										   FontSize="16"
										   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Accent}}"
										   VerticalTextAlignment="Center"/>
								</Border>
								<Label Text="No Borrowed Books Yet"
									   FontSize="22"
									   FontAttributes="Bold"
									   HorizontalTextAlignment="Center"
									   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDarkText}}"/>
								<Label Text="Visit your library to explore our collection and borrow your first book!"
									   FontSize="15"
									   HorizontalTextAlignment="Center"
									   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray200}}"
									   LineBreakMode="WordWrap"
									   MaximumWidthRequest="300"/>
							</StackLayout>
						</CollectionView.EmptyView>
						<CollectionView.ItemsLayout>
							<LinearItemsLayout Orientation="Vertical"
												ItemSpacing="16"/>
						</CollectionView.ItemsLayout>
						<CollectionView.ItemTemplate>
							<DataTemplate x:DataType="models:BorrowedBookDto">
								<Border StrokeThickness="0" 
									   StrokeShape="RoundRectangle 16"
									   Padding="0"
									   BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark=#FF2A2A2A}"
									   Shadow="{Shadow Brush={StaticResource Gray600}, Opacity=0.1, Radius=12, Offset='0,4'}">
									<StackLayout Padding="16" Spacing="16">
										<!-- Book Header Row: Cover + Title & Status -->
										<Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="16">
											<!-- Book Cover Image with shadow -->
											<Border Grid.Column="0"
												   Grid.Row="0"
												   Grid.RowSpan="2"
												   StrokeShape="RoundRectangle 8"
												   StrokeThickness="0"
												   Padding="0"
												   IsVisible="{Binding BookUrl, Converter={StaticResource IsNotNullConverter}}"
												   Shadow="{Shadow Brush={StaticResource Gray600}, Opacity=0.2, Radius=8, Offset='0,2'}">
												<Image Source="{Binding BookUrl}"
													   Aspect="AspectFill"
													   WidthRequest="70"
													   HeightRequest="105"
													   VerticalOptions="Start"/>
											</Border>
											
											<!-- Placeholder for missing cover -->
											<Border Grid.Column="0"
												   Grid.Row="0"
												   Grid.RowSpan="2"
												   WidthRequest="70"
												   HeightRequest="105"
												   StrokeShape="RoundRectangle 8"
												   Padding="0"
												   StrokeThickness="1"
												   Stroke="{AppThemeBinding Light={StaticResource Border}, Dark=#FF404040}"
												   BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark=#FF404040}"
												   IsVisible="{Binding BookUrl, Converter={StaticResource IsNotNullConverter}, ConverterParameter=True}">
												<Label FontFamily="FASolid"
													   Text="{x:Static fa:Solid.Book}"
													   FontSize="32"
													   TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
													   HorizontalTextAlignment="Center"
													   VerticalTextAlignment="Center"/>
											</Border>
											
											<!-- Title -->
											<Label Grid.Column="1"
												   Grid.Row="0"
												   Text="{Binding Title}"
												   FontSize="17"
												   FontAttributes="Bold"
												   VerticalOptions="Center"
												   TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"
												   LineBreakMode="TailTruncation"
												   MaxLines="2"/>
											
											<!-- Status Badge with icon -->
											<Border Grid.Column="1"
												   Grid.Row="1"
												   Padding="12,8"
												   StrokeShape="RoundRectangle 20"
												   StrokeThickness="0"
												   BackgroundColor="{Binding StatusColor, Converter={StaticResource StatusColorConverter}}"
												   VerticalOptions="Start"
												   HorizontalOptions="Start"
												   Margin="0,6,0,0">
												<HorizontalStackLayout Spacing="6">
													<Label FontFamily="FASolid"
														   Text="{x:Static fa:Solid.Clock}"
														   FontSize="12"
														   TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource Gray200}}"
														   VerticalTextAlignment="Center"/>
													<Label Text="{Binding DueStatus}"
														   FontSize="12"
														   FontAttributes="Bold"
														   TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource Gray200}}"
														   VerticalTextAlignment="Center"/>
												</HorizontalStackLayout>
											</Border>
										</Grid>

										<!-- Author Row -->
										<HorizontalStackLayout IsVisible="{Binding Author, Converter={StaticResource IsNotNullConverter}}"
															   Spacing="8">
											<Label FontFamily="FASolid"
												   Text="{x:Static fa:Solid.Pen}"
												   FontSize="13"
												   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
												   VerticalTextAlignment="Center"/>
											<Label Text="{Binding Author}"
												   FontSize="14"
												   TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource Gray200}}"
												   VerticalTextAlignment="Center"
												   LineBreakMode="TailTruncation"/>
										</HorizontalStackLayout>

										<!-- Divider -->
										<BoxView HeightRequest="1"
												 Color="{AppThemeBinding Light={StaticResource Border}, Dark=#FF404040}"
												 Opacity="0.5"
												 Margin="0,0"/>

										<!-- Dates Row: Borrowed and Due -->
										<Grid ColumnDefinitions="*,*" RowDefinitions="Auto" ColumnSpacing="16">
											<!-- Borrowed Date -->
											<StackLayout Grid.Column="0"
														 IsVisible="{Binding BorrowedDate}"
														 Spacing="6">
												<HorizontalStackLayout Spacing="8">
													<Label FontFamily="FASolid"
														   Text="{x:Static fa:Solid.CalendarPlus}"
														   FontSize="12"
														   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
														   VerticalTextAlignment="Center"/>
													<Label Text="Borrowed"
														   FontSize="12"
														   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
														   FontAttributes="Bold"
														   VerticalTextAlignment="Center"/>
												</HorizontalStackLayout>
												<Label Text="{Binding BorrowedDate, StringFormat='{0:MMM dd, yyyy}'}"
													   FontSize="14"
													   FontAttributes="Bold"
													   TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"
													   Margin="20,0,0,0"/>
											</StackLayout>

											<!-- Due Date -->
											<StackLayout Grid.Column="1"
														 IsVisible="{Binding DueDate}"
														 Spacing="6">
												<HorizontalStackLayout Spacing="8">
													<Label FontFamily="FASolid"
														   Text="{x:Static fa:Solid.CalendarCheck}"
														   FontSize="12"
														   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
														   VerticalTextAlignment="Center"/>
													<Label Text="Due Date"
														   FontSize="12"
														   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
														   FontAttributes="Bold"
														   VerticalTextAlignment="Center"/>
												</HorizontalStackLayout>
												<Label Text="{Binding DueDate, StringFormat='{0:MMM dd, yyyy}'}"
													   FontSize="14"
													   FontAttributes="Bold"
													   TextColor="{Binding StatusColor, Converter={StaticResource StatusColorConverter}}"
													   Margin="20,0,0,0"/>
											</StackLayout>
										</Grid>
									</StackLayout>
								</Border>
							</DataTemplate>
						</CollectionView.ItemTemplate>
					</CollectionView>

					<!-- Bottom Padding -->
					<BoxView HeightRequest="24" 
							 BackgroundColor="Transparent"/>
				</StackLayout>
			</ScrollView>
		</RefreshView>

		<!-- Error State -->
		<StackLayout Grid.Row="0" Grid.Column="0"
					 Padding="20"
					 VerticalOptions="Center"
					 HorizontalOptions="Center"
					 IsVisible="{Binding HasError}"
					 Spacing="16"
					 BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">
			<Border StrokeThickness="0"
					Padding="20"
					StrokeShape="RoundRectangle 16"
					BackgroundColor="{AppThemeBinding Light=#FFF5F5F5, Dark=#FF2A1F1F}"
					Shadow="{Shadow Brush={StaticResource Danger}, Opacity=0.2, Radius=10, Offset='0,4'}">
				<StackLayout Spacing="16">
					<Label FontFamily="FASolid"
					   Text="{x:Static fa:Solid.TriangleExclamation}"
					   FontSize="16"
					   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource Accent}}"
					   VerticalTextAlignment="Center"/>
					<Label Text="Unable to Load Books"
						   FontSize="20"
						   FontAttributes="Bold"
						   HorizontalTextAlignment="Center"
						   TextColor="{StaticResource Danger}"/>
					<Label Text="{Binding ErrorMessage}"
						   FontSize="14"
						   HorizontalTextAlignment="Center"
						   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray200}}"
						   LineBreakMode="WordWrap"/>
				</StackLayout>
			</Border>
		</StackLayout>

		<!-- Loading State -->
		<StackLayout Grid.Row="0" Grid.Column="0"
					 Padding="20"
					 VerticalOptions="Center"
					 HorizontalOptions="Center"
					 IsVisible="{Binding IsBusy}"
					 Spacing="20"
					 BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">
			<ActivityIndicator IsRunning="{Binding IsBusy}"
							   IsVisible="{Binding IsBusy}"
							   Color="{StaticResource Primary}"
							   Scale="1.5"/>
			<Label Text="Loading your books..."
				   FontSize="16"
				   HorizontalTextAlignment="Center"
				   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray200}}"/>
		</StackLayout>
	</Grid>

</ContentPage>
