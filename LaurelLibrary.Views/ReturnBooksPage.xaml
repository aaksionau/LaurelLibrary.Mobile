<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:zxing="clr-namespace:ZXing.Net.Maui.Controls;assembly=ZXing.Net.MAUI.Controls"
             xmlns:models="clr-namespace:LaurelLibrary.Core.Models;assembly=LaurelLibrary.Core"
             xmlns:viewmodels="clr-namespace:LaurelLibrary.Core.ViewModels;assembly=LaurelLibrary.Core"
             xmlns:behaviors="clr-namespace:LaurelLibrary.Views.Behaviors;assembly=LaurelLibrary.Views"
             x:Class="LaurelLibrary.Views.ReturnBooksPage"
             Shell.NavBarIsVisible="False"
             x:DataType="viewmodels:ReturnBooksViewModel"
             BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">

    <Grid RowDefinitions="*" ColumnDefinitions="*">
        
        <!-- Scanner View -->
        <Grid Grid.Row="0" Grid.Column="0"
              IsVisible="{Binding IsScanning}"
              RowDefinitions="*"
              ColumnDefinitions="*">
            
            <!-- Camera View with Barcode Scanner -->
            <zxing:CameraBarcodeReaderView
                Grid.Row="0"
                Grid.Column="0"
                x:Name="cameraBarcodeReaderView" />

            <!-- Scanner Overlay with improved layout -->
            <Grid Grid.Row="0" Grid.Column="0"
                  RowDefinitions="Auto,*,Auto"
                  ColumnDefinitions="*"
                  Padding="0"
                  RowSpacing="0">
                
                <!-- Top Section with dark overlay -->
                <BoxView Grid.Row="0" 
                         Color="#66000000"
                         Margin="0"/>
                
                <StackLayout Grid.Row="0"
                             Padding="20,16"
                             Spacing="8"
                             VerticalOptions="Start">
                    <Label Text="Scan Book ISBN"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="{StaticResource White}"
                           HorizontalTextAlignment="Center"/>
                    <Label Text="Point camera at barcode"
                           FontSize="13"
                           TextColor="{StaticResource White}"
                           Opacity="0.85"
                           HorizontalTextAlignment="Center"
                           LineBreakMode="WordWrap"/>
                </StackLayout>

                <!-- Center Section with scanning frame -->
                <StackLayout Grid.Row="1"
                             VerticalOptions="Center"
                             HorizontalOptions="Center"
                             Spacing="20">
                    
                    <!-- Animated Scanning Border -->
                    <Border WidthRequest="200"
                            HeightRequest="200"
                            StrokeShape="RoundRectangle 16"
                            StrokeThickness="3"
                            Stroke="{StaticResource Accent}"
                            BackgroundColor="Transparent"
                            HorizontalOptions="Center"
                            VerticalOptions="Center">
                        <Border.Behaviors>
                            <behaviors:PulseAnimationBehavior />
                        </Border.Behaviors>
                    </Border>

                    <!-- Scanning Status Label with animation -->
                    <StackLayout HorizontalOptions="Center"
                                 Spacing="4">
                        <Label Text="{Binding ScanningStatus}"
                               FontSize="13"
                               TextColor="{StaticResource Accent}"
                               HorizontalTextAlignment="Center"
                               FontAttributes="Bold"/>
                        <ActivityIndicator IsRunning="True"
                                          IsVisible="True"
                                          Color="{StaticResource Accent}"
                                          HorizontalOptions="Center"/>
                    </StackLayout>
                </StackLayout>

                <!-- Bottom Section with tip -->
                <BoxView Grid.Row="2" 
                         Color="#66000000"
                         Margin="0"/>
                
                <StackLayout Grid.Row="2"
                             Padding="20,16"
                             Spacing="0"
                             VerticalOptions="End">
                    <Border StrokeThickness="0"
                            Padding="12,10"
                            StrokeShape="RoundRectangle 8"
                            BackgroundColor="#4DFFFFFF">
                        <Label Text="💡 Good lighting helps faster scanning"
                               FontSize="12"
                               TextColor="{StaticResource White}"
                               HorizontalTextAlignment="Center"
                               LineBreakMode="WordWrap"
                               FontAttributes="Bold"/>
                    </Border>
                </StackLayout>
            </Grid>
        </Grid>

        <!-- Loading State -->
        <Grid Grid.Row="0" Grid.Column="0"
              IsVisible="{Binding IsLoadingDetails}"
              BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}"
              RowDefinitions="*"
              ColumnDefinitions="*">
            
            <StackLayout VerticalOptions="Center"
                         HorizontalOptions="Center"
                         Spacing="16">
                <ActivityIndicator IsRunning="True"
                                  IsVisible="True"
                                  Color="{StaticResource Primary}"
                                  Scale="1.5"/>
                <Label Text="Loading book details..."
                       FontSize="14"
                       TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"
                       HorizontalTextAlignment="Center"/>
            </StackLayout>
        </Grid>

        <!-- Book Details View -->
        <ScrollView Grid.Row="0" Grid.Column="0"
                    IsVisible="{Binding ShowBookDetails}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">
            
            <StackLayout Padding="16" Spacing="16">
                
                <!-- Header -->
                <StackLayout Spacing="4">
                    <Label Text="Confirm Return"
                           FontSize="28"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDarkText}}"/>
                    <Label Text="Review the book details below"
                           FontSize="13"
                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"/>
                </StackLayout>

                <!-- Book Card with improved design -->
                <Border StrokeThickness="1"
                        Stroke="{AppThemeBinding Light={StaticResource Border}, Dark=#FF404040}"
                        StrokeShape="RoundRectangle 14"
                        Padding="16"
                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark=#FF2A2A2A}">
                    
                    <Border.Behaviors>
                        <behaviors:FadeInAnimationBehavior Duration="400"/>
                    </Border.Behaviors>
                    
                    <StackLayout Spacing="14">
                        
                        <!-- Book Cover + Basic Info -->
                        <Grid ColumnDefinitions="75,*" RowDefinitions="Auto,Auto" ColumnSpacing="14" RowSpacing="8">
                            
                            <!-- Book Cover -->
                            <Image Grid.Column="0"
                                   Grid.Row="0"
                                   Grid.RowSpan="2"
                                   Source="{Binding SelectedBook.BookUrl}"
                                   Aspect="AspectFill"
                                   WidthRequest="75"
                                   HeightRequest="112"
                                   VerticalOptions="Start"
                                   IsVisible="{Binding SelectedBook.BookUrl, Converter={StaticResource IsNotNullConverter}}"/>
                            
                            <!-- Placeholder -->
                            <Border Grid.Column="0"
                                    Grid.Row="0"
                                    Grid.RowSpan="2"
                                    WidthRequest="75"
                                    HeightRequest="112"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="0"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light={StaticResource Border}, Dark=#FF404040}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark=#FF404040}"
                                    IsVisible="{Binding SelectedBook.BookUrl, Converter={StaticResource IsNotNullConverter}, ConverterParameter=True}">
                                <Label Text="📖"
                                       FontSize="36"
                                       HorizontalTextAlignment="Center"
                                       VerticalTextAlignment="Center"/>
                            </Border>
                            
                            <!-- Title -->
                            <StackLayout Grid.Column="1"
                                         Grid.Row="0"
                                         Spacing="4">
                                <Label Text="{Binding SelectedBook.Title}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       VerticalOptions="Start"
                                       TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="2"/>
                                <Label Text="{Binding SelectedBook.Author}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                                       IsVisible="{Binding SelectedBook.Author, Converter={StaticResource IsNotNullConverter}}"
                                       LineBreakMode="TailTruncation"/>
                            </StackLayout>
                            
                            <!-- ISBN Badge -->
                            <Border Grid.Column="1"
                                    Grid.Row="1"
                                    Padding="10,6"
                                    StrokeShape="RoundRectangle 12"
                                    StrokeThickness="0"
                                    BackgroundColor="{StaticResource Primary}"
                                    VerticalOptions="Start"
                                    HorizontalOptions="Start">
                                <Label Text="{Binding SelectedBook.Isbn, StringFormat='ISBN: {0}'}"
                                       FontSize="10"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalTextAlignment="Center"
                                       Margin="0"/>
                            </Border>
                        </Grid>

                        <!-- Divider -->
                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Border}, Dark=#FF404040}"/>

                        <!-- Dates Section -->
                        <Grid ColumnDefinitions="*,*" RowDefinitions="Auto" ColumnSpacing="12">
                            
                            <!-- Borrowed Date -->
                            <StackLayout Grid.Column="0"
                                         IsVisible="{Binding SelectedBook.BorrowedDate}"
                                         Spacing="3"
                                         Padding="8">
                                <Label Text="Borrowed"
                                       FontSize="10"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                       FontAttributes="Bold"/>
                                <Label Text="{Binding SelectedBook.BorrowedDate, StringFormat='{0:MMM dd, yyyy}'}"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"/>
                            </StackLayout>

                            <!-- Due Date with Status Color -->
                            <StackLayout Grid.Column="1"
                                         IsVisible="{Binding SelectedBook.DueDate}"
                                         Spacing="3"
                                         Padding="8">
                                <Label Text="Due Date"
                                       FontSize="10"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                       FontAttributes="Bold"/>
                                <Label Text="{Binding SelectedBook.DueDate, StringFormat='{0:MMM dd, yyyy}'}"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       TextColor="{Binding SelectedBook.StatusColor, Converter={StaticResource StatusColorConverter}}"/>
                            </StackLayout>
                        </Grid>
                    </StackLayout>
                </Border>

                <!-- Status Messages -->
                <!-- Success Message -->
                <Border IsVisible="{Binding HasSuccess}"
                        StrokeThickness="1"
                        Stroke="{StaticResource Success}"
                        Padding="14"
                        StrokeShape="RoundRectangle 12"
                        BackgroundColor="{AppThemeBinding Light=#FFF0F7F5, Dark=#FF1A3A35}">
                    
                    <Border.Behaviors>
                        <behaviors:FadeInAnimationBehavior Duration="300"/>
                    </Border.Behaviors>
                    
                    <StackLayout Spacing="6">
                        <Label Text="✓ Return Confirmed"
                               FontSize="13"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Success}"/>
                        <Label Text="{Binding SuccessMessage}"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource Gray200}}"
                               LineBreakMode="WordWrap"/>
                    </StackLayout>
                </Border>

                <!-- Error Message -->
                <Border IsVisible="{Binding HasError}"
                        StrokeThickness="1"
                        Stroke="{StaticResource Danger}"
                        Padding="14"
                        StrokeShape="RoundRectangle 12"
                        BackgroundColor="{AppThemeBinding Light=#FFF5F5F5, Dark=#FF2A1F1F}">
                    
                    <Border.Behaviors>
                        <behaviors:FadeInAnimationBehavior Duration="300"/>
                    </Border.Behaviors>
                    
                    <StackLayout Spacing="6">
                        <Label Text="⚠️ Unable to Return"
                               FontSize="13"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Danger}"/>
                        <Label Text="{Binding ErrorMessage}"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource Gray200}}"
                               LineBreakMode="WordWrap"/>
                    </StackLayout>
                </Border>

                <!-- Action Buttons -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,8,0,0">
                    
                    <!-- Scan Another Button -->
                    <Button Grid.Column="0"
                            Text="Scan Another"
                            Command="{Binding CancelReturnCommand}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"
                            IsEnabled="{Binding IsProcessing, Converter={StaticResource InvertedBoolConverter}}"
                            Padding="16,14"
                            FontSize="13"
                            FontAttributes="Bold"
                            CornerRadius="8"/>
                    
                    <!-- Confirm Return Button -->
                    <Button Grid.Column="1"
                            Text="{Binding IsProcessing, StringFormat='Confirming...', FallbackValue='Confirm Return'}"
                            Command="{Binding ConfirmReturnCommand}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            IsEnabled="{Binding IsProcessing, Converter={StaticResource InvertedBoolConverter}}"
                            Padding="16,14"
                            FontSize="13"
                            FontAttributes="Bold"
                            CornerRadius="8"/>
                </Grid>

                <!-- Bottom Padding -->
                <BoxView HeightRequest="16" BackgroundColor="Transparent"/>
            </StackLayout>
        </ScrollView>

        <!-- Empty State -->
        <StackLayout Grid.Row="0" Grid.Column="0"
                     IsVisible="{Binding ShowEmptyState}"
                     VerticalOptions="Center"
                     HorizontalOptions="Center"
                     Spacing="16"
                     Padding="20">
            <Label Text="No borrowed books"
                   FontSize="18"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center"
                   TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource White}}"/>
            <Label Text="You don't have any borrowed books to return"
                   FontSize="13"
                   HorizontalTextAlignment="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                   LineBreakMode="WordWrap"/>
        </StackLayout>
    </Grid>

</ContentPage>
